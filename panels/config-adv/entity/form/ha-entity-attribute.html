<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel='import' href="../../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../../src/util/hass-attributes-util.html">

<link rel="import" href="../types/ha-entity-array.html">
<link rel="import" href="../types/ha-entity-boolean.html">
<link rel="import" href="../types/ha-entity-icon.html">
<link rel="import" href="../types/ha-entity-key-value.html">
<link rel="import" href="../types/ha-entity-string.html">

<dom-module id="ha-entity-attribute">
  <template>
    <style>
      .form-group {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding: 8px 16px;
      }

      .form-group label {
        @apply(--layout-flex-2);
      }

      .form-group .form-control {
        @apply(--layout-flex);
      }

      .form-group.vertical {
        @apply(--layout-vertical);
        @apply(--layout-start);
      }

      paper-dropdown-menu.form-control {
        margin: -9px 0;
      }
      :host {
        display: block;
        position: relative;
        padding-right: 40px;
      }

      .button {
        position: absolute;
        margin-top: -20px;
        top: 50%;
        right: 0;
      }
    </style>
    <div id='wrapper' class='form-group'></div>
  </template>
</dom-module>

<script>
class HaEntityAttribute extends Polymer.Element {
  static get is() { return 'ha-entity-attribute'; }

  static get properties() {
    return {
      item: {
        type: Object,
        notify: true,
        observer: 'itemObserver',
      }
    };
  }

  itemObserver(item) {
    const wrapper = this.$.wrapper;
    const tag = window.hassAttributeUtil.TYPE_TO_ENTITY_TAG[item.type].toUpperCase();
    let child;
    if (wrapper.lastChild && wrapper.lastChild.tagName === tag) {
      child = wrapper.lastChild;
    } else {
      if (wrapper.lastChild) {
        wrapper.removeChild(wrapper.lastChild);
      }
      // Creating an element with upper case works fine in Chrome, but in FF it doesn't immediately
      // become a defined Custom Element. Polymer does that in some later pass.
      this.$.child = child = document.createElement(tag.toLowerCase());
      child.className = 'form-control';
      child.addEventListener('item-changed', () => {
        this.item = Object.assign({}, child.item);
      });
    }
    console.log(child);
    child.setProperties({ item: this.item });
    if (child.parentNode === null) {
      wrapper.appendChild(child);
    }
  }
}
customElements.define(HaEntityAttribute.is, HaEntityAttribute);
</script>
