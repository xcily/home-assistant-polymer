<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel='import' href='../../../bower_components/paper-listbox/paper-listbox.html'>
<link rel='import' href='../../../bower_components/paper-item/paper-item.html'>
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/app-route/app-route.html'>

<link rel="import" href="../../../src/util/hass-util.html">
<link rel="import" href="../../../src/resources/ha-style.html">
<link rel="import" href="../../../src/util/hass-attributes-util.html">
<link rel="import" href="../ha-config-adv-form-style.html">

<link rel="import" href="./form/ha-form-entity-attributes.html">

<dom-module id="ha-config-adv-entity-editor">
  <template>
    <style include="iron-flex ha-style ha-config-adv-form-style">
      .warning {
        color: red;
      }

      .content {
        padding: 28px 20px 0;
        max-width: 1040px;
        margin: 0 auto;
      }

      .form-group {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding: 8px 16px;
      }

      .form-group label {
        @apply(--layout-flex-2);
      }

      .form-group .form-control {
        @apply(--layout-flex);
      }

      .form-group.vertical {
        @apply(--layout-vertical);
        @apply(--layout-start);
      }

      paper-card {
        display: block;
      }

      .narrow.content {
        max-width: 640px;
      }

      .card-actions {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }

      .attributes-text {
        padding-left: 0px;
        padding-top: 20px;
      }
      .plus-button {
        width: 16px;
        height: 16px;
        margin-left: 16px;
        flex: 0 0 16px;
      }
    </style>
    <app-route
      route="{{route}}"
      pattern="/entity-editor/:entity_id"
      data="{{routeData}}"
      active="{{routeMatch}}"
    ></app-route>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" fixed>
        <app-toolbar>
          <paper-icon-button
            icon='mdi:arrow-left'
            on-tap='_backTapped'
          ></paper-icon-button>
          <div main-title>Entity editor</div>
        </app-toolbar>
      </app-header>
      <div class$='[[computeClasses(isWide)]]'>
        <template is='dom-if' if='[[computeShowWarning(localConfig, homebridgeConfig)]]'>
          <paper-card>
            <div class='card-actions'>
                <div class='form-content'>              
                      <div class="warning">
                        It seems that your configuration.yaml doesn't properly include customize.yaml<br>
                        Changes made here won't affect your configuration.
                      </div>        
                </div>
              </div>
          </paper-card>
        </template>
        <template is='dom-if' if='[[hasBasisAttributes]]'>
          <div><h4 class="attributes-text">BASE Attributes: </h4></div>
          <paper-card>
            <div class='card-actions'>
              <div class='form-content'>
                  <ha-form-entity-attributes attributes="{{basisAttributes}}" isWide=[[isWide]]></ha-form-entity-attributes>         
              </div>
            </div>
          </paper-card>
        </template>
        <template is='dom-if' if='[[hasLocalAttributes]]'>
          <div><h4 class="attributes-text">Entity Attributes: </h4></div>
           <paper-card>
            <div class='card-actions'>
              <div class='form-content'>              
                  <ha-form-entity-attributes attributes="{{localAttributes}}" isWide=[[isWide]]></ha-form-entity-attributes>
              </div>
            </div>
          </paper-card>
        </template>
        <template is='dom-if' if='[[hasHomebridgeAttributes]]'>
          <div><h4 class="attributes-text">HomeBridge Attributes: </h4></div>
          <paper-card>
            <div class='card-actions'>
              <div class='form-content'>              
                  <ha-form-entity-attributes attributes="{{homebridgeAttributes}}" isWide=[[isWide]]></ha-form-entity-attributes>
              </div>
            </div>
          </paper-card>
        </template>
        <template is='dom-if' if='[[hasOtherAttributes]]'>
           <div><h4 class="attributes-text">Other Attributes: </h4></div>
           <paper-card>
            <div class='card-actions'>
              <div class='form-content'>
                    <ha-form-entity-attributes attributes="{{otherAttributes}}" isWide=[[isWide]]></ha-form-entity-attributes>
              </div>
            </div>
          </paper-card>
        </template>
        <div><h4 class="attributes-text">Customize Attributes: </h4></div>
         <paper-card>
          <div class='card-content'>
            <div class='form-container'>
              <template is='dom-if' if='[[hasNewAttributes]]'>
                <ha-form-entity-attributes attributes="{{newAttributes}}" isWide=[[isWide]]></ha-form-entity-attributes>
              </template>          
              <div class='form-group'>
                 <paper-icon-button icon="mdi:plus" on-tap='addCustomizeAttributes'></paper-icon-button>
              </div>
            </div>
          </div>
        </paper-card>
        <paper-card>
          <div class='card-actions'>
            <paper-button
              on-tap='saveEntity'
            >SAVE
            </paper-button>
            <template is='dom-if' if='[[allowDelete]]'>
              <paper-button
                class='warning'
                on-tap='deleteEntity'
              >DELETE
              </paper-button>
            </template>
          </div>
          
        </paper-card>
      </div>
    </app-header-layout>
  </template>
</dom-module>
<script>
  class HaConfigAdvEntityEditor extends window.hassMixins.EventsMixin(Polymer.Element) {
    static get is() {
      return 'ha-config-adv-entity-editor';
    }

    static get properties() {
      return {
        hass: Object,
        route: Object,
        routeData: Object,
        isWide: Boolean,
        entity: {
          type: Object,
          computed: 'computeEntity(hass, routeData, routeMatch)',
        },
        basisAttributes: {
          type: Array,
          computed: 'computeBasisAttributes(basisConfig,entity)',
        },
        hasBasisAttributes: Boolean,

        localAttributes: {
          type: Array,
          computed: 'computeLocalAttributes(localConfig, basisConfig, entity)',
        },
        hasLocalAttributes: Boolean,

        homebridgeAttributes: {
          type: Array,
          computed: 'computeHomebridgeAttributes(localConfig, homebridgeConfig, basisConfig, entity)',
        },
        hasHomebridgeAttributes: Boolean,

        otherAttributes: {
          type: Array,
          computed: 'computeOtherAttributes(localConfig, homebridgeConfig, basisConfig, entity)',
        },
        hasOtherAttributes: Boolean,

        hasNewAttributes: Boolean,
        newAttributesOptions: Array,
    

        basisConfig: {
          type: Object,
          value: {
            friendly_name: '',
            hidden: '',
            icon: '',
          }
        },
        localConfig: {
          type: Object,
          value: {
            device_class: '',
            emulated_hue: '',
          },
        },
        homebridgeConfig: {
          type: Object,
          value: {
            homebridge_name: '',
            homebridge_hidden: '',
          },
        },
        newAttributes: {
          type: Object,
          value: [],
        },
      };
    }


    static get observers() {
      return [
        'attributesObserver(localAttributes.*, homebridgeAttributes.*, basisAttributes.*, otherAttributes.*, newAttributes.*)',
      ];
    }

    _backTapped() {
      history.back();
    }

    computeClasses(isWide) {
      return isWide ? 'content ' : 'content narrow';
    }

    computeEntityId(routeData) {
      return routeData.entity_id;
    }

    computeEntity(hass, routeData, routeMatch) {
      var entity;
      if (routeMatch && routeData) {
        entity = hass.states[routeData.entity_id];
      }
      return entity;
    }

    saveEntity() {
      const data = {};
      const attrs = this.localAttributes
        .concat(this.homebridgeAttributes, this.otherAttributes, this.newAttributes, this.basisAttributes);
      attrs.forEach((attr) => {
        if (attr.closed || attr.secondary || !attr.attribute || !attr.value) return;
        const value = attr.type === 'json' ? JSON.parse(attr.value) : attr.value;
        if (!value) return;
        data[attr.attribute] = value;
      });

      const objectId = this.entity.entity_id;
      return this.hass.callApi('POST', 'config/entity/config_adv/' + objectId, data);
    }

    computeIcon(stateObj) {
      return window.hassUtil.stateIcon(stateObj);
    }

    _initOpenObject(key, value, secondary, config) {
      return Object.assign({
        attribute: key,
        value: value,
        closed: false,
        domain: window.hassUtil.computeDomain(this.entity),
        secondary: secondary,
        description: key,
      }, config);
    }

    _computeSingleAttribute(key, value, secondary) {
      const config = window.hassAttributeUtil.LOGIC_STATE_ATTRIBUTES[key]
        || {type: window.hassAttributeUtil.UNKNOWN_TYPE};
      return this._initOpenObject(key, config.type === 'json' ? JSON.stringify(value) : value, secondary, config);
    }

    _computeAttributes(config, keys, secondary) {
      return keys.map(key => this._computeSingleAttribute(key, config[key], secondary));
    }

    computeLocalAttributes(localConfig, basisConfig, entity) {
      if (!localConfig || !basisConfig || !entity) return [];
      const basisKeys = Object.keys(basisConfig);
      const localKeys = Object.keys(localConfig).filter(key => !basisKeys.includes(key));
      const result = this._computeAttributes(entity.attributes, localKeys, false);
      return result;
    }


    computeBasisAttributes(basisConfig, entity) {
      if (!basisConfig || !entity) return [];
      const basisKeys = Object.keys(basisConfig);
      return this._computeAttributes(entity.attributes, basisKeys, false);
    }

    computeHomebridgeAttributes(localConfig, homebridgeConfig, basisConfig, entity) {
      if (!localConfig || !homebridgeConfig || !basisConfig || !entity) return [];
      const localKeys = Object.keys(localConfig);
      const basisKeys = Object.keys(basisConfig);
      const homebridgeKeys = Object.keys(homebridgeConfig)
        .filter(key => !localKeys.includes(key) && !basisKeys.includes(key));
      return this._computeAttributes(entity.attributes, homebridgeKeys, false);
    }

    computeOtherAttributes(localConfig, homebridgeConfig, basisConfig, entity) {
      if (!localConfig || !homebridgeConfig || !entity || !basisConfig) return [];
      const localKeys = Object.keys(localConfig);
      const basisKeys = Object.keys(basisConfig);
      const homebridgeKeys = Object.keys(homebridgeConfig);
      const otherKeys =
        Object.keys(window.hassAttributeUtil.LOGIC_STATE_ATTRIBUTES)
          .filter((key) => {
            const conf = window.hassAttributeUtil.LOGIC_STATE_ATTRIBUTES[key];
            return conf && (!conf.domains || !this.entity ||
              conf.domains.includes(window.hassUtil.computeDomain(this.entity)));
          }) 
          .filter((key) => !localKeys.includes(key) && !basisKeys.includes(key) && !homebridgeKeys.includes(key));
      return this._computeAttributes(entity.attributes, otherKeys, false);
    }

    computeShowWarning(localConfig, homebridgeConfig) {
      if (!localConfig || !homebridgeConfig) return false;
      return Object.keys(localConfig)
        .some(key => JSON.stringify(homebridgeConfig[key]) !== JSON.stringify(localConfig[key]));
    }

    attributesObserver() {
      this.hasBasisAttributes =
        this.basisAttributes && this.basisAttributes.some(attr => !attr.closed);
      this.hasLocalAttributes =
        this.localAttributes && this.localAttributes.some(attr => !attr.closed);
      this.hasHomebridgeAttributes =
        this.homebridgeAttributes && this.homebridgeAttributes.some(attr => !attr.closed);
      this.hasOtherAttributes =
        this.otherAttributes && this.otherAttributes.some(attr => !attr.closed);
      this.hasNewAttributes =
        this.newAttributes && this.newAttributes.some(attr => !attr.closed);
    }
    addCustomizeAttributes(){
      const attr = this._initOpenObject('', '', false /* secondary */, {type: window.hassAttributeUtil.ADD_TYPE});
      this.push('newAttributes', attr);
    }
    
  }
  customElements.define(HaConfigAdvEntityEditor.is, HaConfigAdvEntityEditor);
</script>